-- EQUIPMENT_TYPE (Normalización de tipos de equipamiento)
CREATE TABLE EquipmentType (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL UNIQUE,  -- 'Treadmill', 'Elliptical', 'Chest Press', etc.
    category VARCHAR(20) NOT NULL,     -- 'Cardio', 'Strength'
    CONSTRAINT chk_category CHECK (category IN ('Cardio', 'Strength'))
);

-- MANUFACTURER (Normalización de fabricantes)
CREATE TABLE Manufacturer (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL UNIQUE   -- 'Life Fitness', 'Precor', 'Technogym', 'Hammer Strength'
);

-- LOCATION (Normalización de ubicaciones/zonas del gimnasio)
CREATE TABLE Location (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL UNIQUE,  -- 'Cardio Zone', 'Strength Area'
    gymId INT NOT NULL,
    FOREIGN KEY (gymId) REFERENCES Gym(id) ON DELETE CASCADE
);

-- EQUIPMENT (Equipamiento maestro - equivalente a equipment_master_2.csv)
-- Extiende la información de Machine con datos de adquisición y criticidad
CREATE TABLE Equipment (
    id INT PRIMARY KEY AUTO_INCREMENT,
    equipmentCode VARCHAR(20) NOT NULL UNIQUE,  -- 'CARD-001', 'STR-001', etc.
    machineId INT NOT NULL UNIQUE,              -- Relación 1:1 con Machine
    equipmentTypeId INT NOT NULL,
    manufacturerId INT NOT NULL,
    locationId INT NOT NULL,
    purchaseDate DATE NOT NULL,
    purchaseCost DECIMAL(10,2) NOT NULL,
    replacementValue DECIMAL(10,2) NOT NULL,
    criticality DECIMAL(2,1) NOT NULL,          -- 1.0 - 5.0
    FOREIGN KEY (machineId) REFERENCES Machine(id) ON DELETE CASCADE,
    FOREIGN KEY (equipmentTypeId) REFERENCES EquipmentType(id),
    FOREIGN KEY (manufacturerId) REFERENCES Manufacturer(id),
    FOREIGN KEY (locationId) REFERENCES Location(id),
    CONSTRAINT chk_criticality CHECK (criticality BETWEEN 1.0 AND 5.0)
);

-- EQUIPMENT_METRICS (Métricas mensuales de uso y condición - equipment_metrics_2.csv)
CREATE TABLE EquipmentMetrics (
    id INT PRIMARY KEY AUTO_INCREMENT,
    equipmentId INT NOT NULL,
    recordMonth DATE NOT NULL,                   -- Primer día del mes (YYYY-MM-01)
    ageMonths INT NOT NULL,                      -- Edad en meses desde compra
    totalOperationalHours INT NOT NULL,          -- Horas acumuladas totales
    totalSessions INT NOT NULL,                  -- Sesiones acumuladas totales
    avgDailyPeakUsage INT NOT NULL,              -- Usuarios pico promedio diario
    daysSinceLastFailure INT NOT NULL,           -- Días desde último fallo
    failureCount12m INT NOT NULL DEFAULT 0,      -- Fallos en últimos 12 meses
    maintenanceCost12m DECIMAL(10,2) NOT NULL DEFAULT 0.00,  -- Costo mantenimiento 12m
    downtimeDays12m DECIMAL(4,1) NOT NULL DEFAULT 0.0,       -- Días inactivo 12m
    vibrationLevel DECIMAL(4,2) NOT NULL,        -- Nivel de vibración (sensor)
    temperatureDeviation DECIMAL(4,2) NOT NULL,  -- Desviación temperatura (sensor)
    powerConsumption DECIMAL(4,2) NOT NULL,      -- Consumo energético (kW)
    daysUntilNextFailure INT,                    -- Predicción de días hasta fallo
    FOREIGN KEY (equipmentId) REFERENCES Equipment(id) ON DELETE CASCADE,
    UNIQUE KEY uk_equipment_month (equipmentId, recordMonth)
);

-- MAINTENANCE_TYPE (Normalización de tipos de mantenimiento)
CREATE TABLE MaintenanceType (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(20) NOT NULL UNIQUE,   -- 'Preventive', 'Corrective', 'Emergency'
    description TEXT
);

-- FAILURE_MODE (Normalización de modos de fallo)
CREATE TABLE FailureMode (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL UNIQUE,   -- 'Belt', 'Motor', 'Electrical', 'Hydraulic', etc.
    severity VARCHAR(20),               -- 'Minor', 'Moderate', 'Critical'
    description TEXT
);

-- TECHNICIAN (Normalización de técnicos)
CREATE TABLE Technician (
    id INT PRIMARY KEY AUTO_INCREMENT,
    code VARCHAR(20) NOT NULL UNIQUE,   -- 'TECH-01', 'TECH-02'
    name VARCHAR(100) NOT NULL,
    specialization VARCHAR(50),         -- 'Cardio', 'Strength', 'General'
    phoneNumber VARCHAR(20),
    email VARCHAR(100)
);

-- MAINTENANCE_HISTORY (Historial de mantenimiento - maintenance_history_2.csv)
CREATE TABLE MaintenanceHistory (
    id INT PRIMARY KEY AUTO_INCREMENT,
    workOrderId VARCHAR(20) NOT NULL UNIQUE,    -- 'WO-001', 'WO-002', etc.
    equipmentId INT NOT NULL,
    maintenanceTypeId INT NOT NULL,
    failureModeId INT,                          -- NULL si es preventivo
    technicianId INT NOT NULL,
    dateReported DATE NOT NULL,
    dateCompleted DATE NOT NULL,
    repairCost DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    downtimeDays DECIMAL(4,1) NOT NULL DEFAULT 0.0,
    partsReplaced TEXT,                         -- Descripción de partes reemplazadas
    notes TEXT,
    FOREIGN KEY (equipmentId) REFERENCES Equipment(id) ON DELETE CASCADE,
    FOREIGN KEY (maintenanceTypeId) REFERENCES MaintenanceType(id),
    FOREIGN KEY (failureModeId) REFERENCES FailureMode(id),
    FOREIGN KEY (technicianId) REFERENCES Technician(id),
    CONSTRAINT chk_dates CHECK (dateCompleted >= dateReported)
);

-- PARTS_INVENTORY (Inventario de repuestos)
CREATE TABLE PartsInventory (
    id INT PRIMARY KEY AUTO_INCREMENT,
    partName VARCHAR(100) NOT NULL,
    partNumber VARCHAR(50) UNIQUE,
    description TEXT,
    unitCost DECIMAL(10,2) NOT NULL,
    quantityInStock INT NOT NULL DEFAULT 0,
    reorderLevel INT NOT NULL DEFAULT 5,
    supplierId INT,
    CONSTRAINT chk_quantity CHECK (quantityInStock >= 0)
);

-- MAINTENANCE_PARTS (Relación N:M entre mantenimiento y repuestos usados)
CREATE TABLE MaintenanceParts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    maintenanceHistoryId INT NOT NULL,
    partId INT NOT NULL,
    quantityUsed INT NOT NULL,
    FOREIGN KEY (maintenanceHistoryId) REFERENCES MaintenanceHistory(id) ON DELETE CASCADE,
    FOREIGN KEY (partId) REFERENCES PartsInventory(id),
    UNIQUE KEY uk_maintenance_part (maintenanceHistoryId, partId)
);
